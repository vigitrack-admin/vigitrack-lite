<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>VigiTrack Lite – Device Vigilance & NABH Compliance</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
:root{
  --primary:#0a3d62;
  --bg:#eef3f7;
  --accent:#1e90ff;
  --success:#27ae60;
  --warning:#f39c12;
  --danger:#c0392b;
  --text:#2c3e50;
}
body{
  margin:0;
  font-family:Segoe UI,Arial,sans-serif;
  background:var(--bg);
  color:var(--text);
}
header{
  background:var(--primary);
  color:#fff;
  padding:16px;
  text-align:center;
}
.container{
  max-width:1200px;
  margin:auto;
  padding:16px;
}
.card{
  background:#fff;
  padding:16px;
  margin-bottom:18px;
  border-radius:8px;
  box-shadow:0 3px 8px rgba(0,0,0,0.08);
}
h2{
  margin-top:0;
  color:var(--primary);
}
.grid{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(230px,1fr));
  gap:12px;
}
label{
  font-size:13px;
  font-weight:600;
}
label span{
  font-size:12px;
  font-weight:400;
  color:#666;
}
input,select,textarea{
  width:100%;
  padding:10px;
  border:1px solid #ccc;
  border-radius:6px;
  margin-top:4px;
}
textarea{resize:vertical;}
button{
  padding:12px;
  border:none;
  border-radius:6px;
  font-size:14px;
  cursor:pointer;
}
.btn-primary{background:var(--accent);color:#fff;}
.btn-secondary{background:#7f8c8d;color:#fff;}
.badge{
  padding:4px 10px;
  color:#fff;
  border-radius:12px;
  font-size:12px;
}
.low{background:var(--success);}
.medium{background:var(--warning);}
.high{background:var(--danger);}
table{
  width:100%;
  border-collapse:collapse;
  font-size:13px;
}
th,td{
  padding:8px;
  border-bottom:1px solid #ddd;
}
.filter-bar{
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  margin-bottom:10px;
}
@media(max-width:600px){
  table{font-size:12px;}
}
</style>
</head>

<body>

<header>
  <h1>VigiTrack Lite</h1>
  <p>Medical Device Incident, Vigilance & NABH Audit System</p>
</header>

<div class="container">

<!-- INCIDENT FORM -->
<div class="card">
<h2>Device Incident & Quality Record</h2>

<div class="grid">

<div>
<label>Device Name</label>
<input id="device" required>
</div>

<!-- ✅ EVENT DATE – PROMINENT & MANDATORY -->
<div>
<label>Event / Complaint Registration Date <span>(Mandatory – NABH)</span></label>
<input type="date" id="eventDate" required>
</div>

<div>
<label>Department</label>
<input id="department" placeholder="ICU / OT">
</div>

<div>
<label>Reporter Role</label>
<select id="role">
<option>Nurse</option>
<option>Technician</option>
<option>Biomedical Engineer</option>
<option>Doctor</option>
</select>
</div>

<div>
<label>Manufacturer / Hospital Group</label>
<select id="manufacturer">
<option>Siemens</option>
<option>GE Healthcare</option>
<option>Philips</option>
<option>Apollo Hospitals</option>
<option>Fortis Healthcare</option>
<option>Max Healthcare</option>
<option>Medanta</option>
<option>Manipal Hospitals</option>
<option>Aster DM Healthcare</option>
<option>Acibadem</option>
<option>Sakra World Hospital</option>
<option>CARE Hospitals</option>
<option>Narayana Health</option>
<option>Columbia Asia</option>
</select>
</div>

<div>
<label>Device Category</label>
<select id="category">
<option>Critical</option>
<option>Non-critical</option>
</select>
</div>

<div>
<label>Patient Involved?</label>
<select id="patient">
<option value="no">No</option>
<option value="yes">Yes</option>
</select>
</div>

<div>
<label>Injury Occurred?</label>
<select id="injury">
<option value="no">No</option>
<option value="yes">Yes</option>
</select>
</div>

<div>
<label>Device Malfunction?</label>
<select id="malfunction">
<option value="no">No</option>
<option value="yes">Yes</option>
</select>
</div>

<div>
<label>Risk Assessment</label>
<select id="risk">
<option>Low</option>
<option>Medium</option>
<option>High</option>
</select>
</div>

<div>
<label>Investigation Status</label>
<select id="status">
<option>Open</option>
<option>In Progress</option>
<option>Closed</option>
</select>
</div>

<div>
<label>Root Cause Category</label>
<select id="rootCause">
<option>Material Defect</option>
<option>User Error</option>
<option>Maintenance Issue</option>
<option>Other</option>
</select>
</div>

<div>
<label>Corrective Action Required?</label>
<select id="caRequired">
<option>No</option>
<option>Yes</option>
</select>
</div>

<div>
<label>NABH Compliance Status</label>
<select id="nabh">
<option>Pending</option>
<option>Compliant</option>
<option>Non-Compliant</option>
</select>
</div>

<div>
<label>Regulatory Notification Required?</label>
<select id="regNotify">
<option>No</option>
<option>Yes</option>
</select>
</div>

<div>
<label>Regulatory Body</label>
<select id="regBody">
<option>CDSCO</option>
<option>State Health Department</option>
</select>
</div>

</div>

<label>Corrective Action Description</label>
<textarea id="caDesc"></textarea>

<label>Quality Assurance Head Name</label>
<input id="qaHead">

<label>QA Sign-off Date</label>
<input type="date" id="qaDate">

<button class="btn-primary" onclick="saveIncident()">Save Incident</button>
</div>

<!-- FILTER & TABLE -->
<div class="card">
<div class="filter-bar">
<select id="filterSeverity" onchange="loadTable()">
<option value="">All Severities</option>
<option>Low</option>
<option>Medium</option>
<option>High</option>
</select>

<select id="filterStatus" onchange="loadTable()">
<option value="">All Status</option>
<option>Open</option>
<option>In Progress</option>
<option>Closed</option>
</select>

<button class="btn-secondary" onclick="downloadCSV()">Download CSV</button>
</div>

<table>
<thead>
<tr>
<th>Device</th>
<th>Event Date</th>
<th>Dept</th>
<th>Severity</th>
<th>Risk</th>
<th>Status</th>
<th>PDF</th>
</tr>
</thead>
<tbody id="tableBody"></tbody>
</table>
</div>

</div>

<script>
const KEY="vigitrack_final";

function classifySeverity(p,i,m){
 if(p && i && m) return "High";
 if(m) return "Medium";
 return "Low";
}

function saveIncident(){
 let eventDate=document.getElementById("eventDate").value;
 if(!eventDate){
   alert("Event / Complaint Registration Date is mandatory");
   return;
 }

 let data=JSON.parse(localStorage.getItem(KEY)||"[]");

 let incident={
  device:device.value,
  eventDate:eventDate,
  department:department.value,
  role:role.value,
  manufacturer:manufacturer.value,
  category:category.value,
  patient:patient.value,
  injury:injury.value,
  malfunction:malfunction.value,
  risk:risk.value,
  status:status.value,
  rootCause:rootCause.value,
  caRequired:caRequired.value,
  caDesc:caDesc.value,
  nabh:nabh.value,
  regNotify:regNotify.value,
  regBody:regBody.value,
  qaHead:qaHead.value,
  qaDate:qaDate.value,
  severity:classifySeverity(
    patient.value==="yes",
    injury.value==="yes",
    malfunction.value==="yes"
  )
 };

 data.push(incident);
 localStorage.setItem(KEY,JSON.stringify(data));
 loadTable();
 alert("Incident saved successfully");
}

function loadTable(){
 let body=document.getElementById("tableBody");
 body.innerHTML="";
 let fs=document.getElementById("filterSeverity").value;
 let fst=document.getElementById("filterStatus").value;

 let data=JSON.parse(localStorage.getItem(KEY)||"[]");

 data.forEach((d,i)=>{
  if(fs && d.severity!==fs) return;
  if(fst && d.status!==fst) return;

  body.innerHTML+=`
  <tr>
    <td>${d.device}</td>
    <td>${d.eventDate}</td>
    <td>${d.department}</td>
    <td><span class="badge ${d.severity.toLowerCase()}">${d.severity}</span></td>
    <td>${d.risk}</td>
    <td>${d.status}</td>
    <td><button onclick="exportPDF(${i})">PDF</button></td>
  </tr>`;
 });
}

function exportPDF(i){
 const {jsPDF}=window.jspdf;
 let d=JSON.parse(localStorage.getItem(KEY))[i];
 let pdf=new jsPDF();
 let y=15;
 pdf.text("Medical Device Incident & NABH Audit Record",20,y); y+=10;
 Object.keys(d).forEach(k=>{
   pdf.text(`${k}: ${d[k]}`,20,y);
   y+=8;
 });
 pdf.save("VigiTrack_NABH_Incident.pdf");
}

function downloadCSV(){
 let data=JSON.parse(localStorage.getItem(KEY)||"[]");
 if(!data.length){ alert("No records available"); return; }

 let csv=Object.keys(data[0]).join(",")+"\n";
 data.forEach(r=>{
   csv+=Object.values(r).join(",")+"\n";
 });

 let blob=new Blob([csv],{type:"text/csv"});
 let a=document.createElement("a");
 a.href=URL.createObjectURL(blob);
 a.download="VigiTrack_Incident_Log.csv";
 a.click();
}

loadTable();
</script>

</body>
</html>
