<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>VigiTrack Lite – Medical Device Incident Reporting</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Styling -->
<style>
body {
    font-family: Arial, Helvetica, sans-serif;
    background: #f4f6f9;
    margin: 0;
    padding: 0;
}
header {
    background: #0b5ed7;
    color: #fff;
    padding: 16px;
    text-align: center;
}
.container {
    max-width: 1200px;
    margin: auto;
    padding: 20px;
}
.card {
    background: #fff;
    border-radius: 6px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
}
h2 {
    margin-top: 0;
}
label {
    font-weight: bold;
    display: block;
    margin-top: 10px;
}
input, select, textarea {
    width: 100%;
    padding: 8px;
    margin-top: 4px;
}
textarea {
    resize: vertical;
}
button {
    margin-top: 12px;
    padding: 10px 14px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
}
.btn-primary { background: #0b5ed7; color: #fff; }
.btn-danger { background: #dc3545; color: #fff; }
.btn-secondary { background: #6c757d; color: #fff; }
.btn-success { background: #198754; color: #fff; }

table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 10px;
}
th, td {
    border: 1px solid #ccc;
    padding: 8px;
    text-align: left;
}
th {
    background: #e9ecef;
}
.actions button {
    margin-right: 5px;
}
.counter {
    font-size: 16px;
    font-weight: bold;
}
@media(max-width: 768px) {
    table, thead, tbody, th, td, tr {
        display: block;
    }
    tr { margin-bottom: 15px; }
    th { display: none; }
}
</style>

<!-- jsPDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<!-- Firebase SDKs -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AtzaSyACC32QUpZuZfTvUkzmYkF356mcag12w1E",
  authDomain: "vigitrack-lite.firebaseapp.com",
  projectId: "vigitrack-lite",
  storageBucket: "vigitrack-lite.firebasestorage.app",
  messagingSenderId: "1071730133872",
  appId: "1:1071730133872:web:1aee3ae466fb7729e29db5",
  measurementId: "G-KKTLM1VRXH"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

signInAnonymously(auth);

const complaintsRef = collection(db, "complaints");
const tableBody = document.getElementById("complaintsTable");
const counter = document.getElementById("count");

let editId = null;

/* Generate Complaint ID */
function generateID() {
    return "VT-" + Date.now();
}
document.getElementById("complaintId").value = generateID();

/* Save / Update Complaint */
document.getElementById("complaintForm").addEventListener("submit", async e => {
    e.preventDefault();

    const data = {
        complaintId: document.getElementById("complaintId").value,
        eventDate: document.getElementById("eventDate").value,
        deviceName: document.getElementById("deviceName").value,
        description: document.getElementById("description").value,
        patientCount: document.getElementById("patientCount").value,
        severity: document.getElementById("severity").value,
        hospital: document.getElementById("hospital").value,
        department: document.getElementById("department").value,
        deviceNumber: document.getElementById("deviceNumber").value,
        userId: document.getElementById("userId").value,
        status: document.getElementById("status").value,
        createdAt: new Date()
    };

    if (editId) {
        await updateDoc(doc(db, "complaints", editId), data);
        editId = null;
    } else {
        await addDoc(complaintsRef, data);
    }

    e.target.reset();
    document.getElementById("complaintId").value = generateID();
});

/* Load Complaints */
onSnapshot(complaintsRef, snapshot => {
    tableBody.innerHTML = "";
    counter.textContent = snapshot.size;

    snapshot.forEach(docSnap => {
        const c = docSnap.data();
        const row = document.createElement("tr");

        row.innerHTML = `
        <td>${c.complaintId}</td>
        <td>${c.eventDate}</td>
        <td>${c.deviceName}</td>
        <td>${c.severity}</td>
        <td>${c.status}</td>
        <td class="actions">
            <button class="btn-secondary">Edit</button>
            <button class="btn-danger">Delete</button>
        </td>`;

        row.querySelector(".btn-secondary").onclick = () => {
            editId = docSnap.id;
            for (let k in c) {
                if (document.getElementById(k)) {
                    document.getElementById(k).value = c[k];
                }
            }
        };

        row.querySelector(".btn-danger").onclick = async () => {
            if (confirm("Delete this complaint?")) {
                await deleteDoc(doc(db, "complaints", docSnap.id));
            }
        };

        tableBody.appendChild(row);
    });
});

/* Random Generator */
document.getElementById("randomBtn").onclick = () => {
    document.getElementById("complaintId").value = generateID();
    document.getElementById("eventDate").value = new Date().toISOString().split("T")[0];
    document.getElementById("deviceName").value = "Infusion Pump";
    document.getElementById("description").value = "Unexpected alarm and flow interruption.";
    document.getElementById("patientCount").value = 1;
    document.getElementById("severity").value = "Major";
    document.getElementById("hospital").value = "City Hospital";
    document.getElementById("department").value = "ICU";
    document.getElementById("deviceNumber").value = "MD-45721";
    document.getElementById("userId").value = "User-01";
    document.getElementById("status").value = "Open";
};

/* Export PDF */
document.getElementById("pdfBtn").onclick = () => {
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF();
    pdf.text("VigiTrack Lite – Complaint Report", 10, 10);
    let y = 20;

    document.querySelectorAll("#complaintsTable tr").forEach(row => {
        pdf.text(row.innerText, 10, y);
        y += 10;
    });

    pdf.save("vigitrack_complaints.pdf");
};
</script>
</head>

<body>

<header>
<h1>VigiTrack Lite</h1>
<p>Medical Device Incident Reporting System</p>
</header>

<div class="container">

<div class="card">
<h2>New Complaint</h2>
<form id="complaintForm">

<label>Complaint ID</label>
<input id="complaintId" readonly>

<label>Event Date</label>
<input type="date" id="eventDate" required>

<label>Device Name</label>
<select id="deviceName">
<option>Cardiac Monitor</option>
<option>Ventilator</option>
<option>Defibrillator</option>
<option>ECG Machine</option>
<option>Infusion Pump</option>
<option>Pulse Oximeter</option>
</select>

<label>Incident Description</label>
<textarea id="description"></textarea>

<label>Affected Patient Count</label>
<input type="number" id="patientCount">

<label>Severity</label>
<select id="severity">
<option>Critical</option>
<option>Major</option>
<option>Minor</option>
</select>

<label>Hospital Name</label>
<input id="hospital">

<label>Department</label>
<input id="department">

<label>Medical Device Number</label>
<input id="deviceNumber">

<label>User ID</label>
<input id="userId">

<label>Status</label>
<select id="status">
<option>Open</option>
<option>Under Investigation</option>
<option>Closed</option>
</select>

<button class="btn-primary" type="submit">Save Complaint</button>
<button type="button" class="btn-success" id="randomBtn">Generate Random</button>

</form>
</div>

<div class="card">
<h2>All Complaints</h2>
<p class="counter">Total Complaints: <span id="
